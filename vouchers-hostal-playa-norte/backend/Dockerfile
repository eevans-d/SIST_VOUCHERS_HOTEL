# ============================================\n# STAGE 1: Builder\n# ============================================ \nFROM node:18-alpine AS builder\n\nLABEL maintainer=\"Hostal Playa Norte <dev@hostalplayanorte.com>\"\nLABEL description=\"Sistema de Vouchers Digitales - Backend\"\n\nWORKDIR /app\n\n# Instalar dependencias de build\nRUN apk add --no-cache python3 make g++\n\n# Copiar archivos de dependencias\nCOPY package*.json .\n\n# Instalar dependencias (solo producci칩n)\nRUN npm ci --only=production --ignore-scripts\n\n# Copiar c칩digo fuente\nCOPY . .\n\n# ============================================ \n# STAGE 2: Production\n# ============================================ \nFROM node:18-alpine\n\nWORKDIR /app\n\n# Instalar solo runtime necesario\nRUN apk add --no-cache tini curl\n\n# Crear usuario no-root\nRUN addgroup -g 1001 -S nodejs && \    adduser -S nodejs -u 1001\n\n# Copiar node_modules desde builder\nCOPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules\n\n# Copiar aplicaci칩n\nCOPY --chown=nodejs:nodejs src ./src\nCOPY --chown=nodejs:nodejs db ./db\nCOPY --chown=nodejs:nodejs package*.json .\n\n# Crear directorios necesarios\nRUN mkdir -p /data /app/logs && \    chown -R nodejs:nodejs /data /app/logs\n\n# Variables de entorno por defecto\nENV NODE_ENV=production \    PORT=3000 \    DATABASE_PATH=/data/vouchers.db \    TZ=America/Argentina/Buenos_Aires\n\n# Cambiar a usuario no-root\nUSER nodejs\n\n# Health check\nHEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \  CMD node -e \"require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); });\"\n\n# Exponer puerto\nEXPOSE 3000\n\n# Usar tini para manejo correcto de se침ales\nENTRYPOINT [\"/sbin/tini\", \"--\"]\n\n# Comando de inicio\nCMD [\"node\", \"src/server.js\"]\n