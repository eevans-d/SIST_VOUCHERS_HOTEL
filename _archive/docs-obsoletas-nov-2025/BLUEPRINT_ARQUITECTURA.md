# ğŸ—ï¸ BLUEPRINT ARQUITECTÃ“NICO
## Sistema Vouchers Digitales - Hostal Playa Norte

---

## ğŸ“ DIAGRAMA DE ARQUITECTURA COMPLETA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CAPA DE PRESENTACIÃ“N (PWA)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Login & Auth   â”‚  â”‚  Scanner QR      â”‚  â”‚  Redemption Manager     â”‚  â”‚
â”‚  â”‚  - JWT Storage  â”‚  â”‚  - HTML5 QR      â”‚  â”‚  - Form validation      â”‚  â”‚
â”‚  â”‚  - Role display â”‚  â”‚  - Manual input  â”‚  â”‚  - Offline queue        â”‚  â”‚
â”‚  â”‚  - Session mgmt â”‚  â”‚  - HMAC validate â”‚  â”‚  - Conflict resolution  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Sync Status    â”‚  â”‚  Reports View    â”‚  â”‚  Settings               â”‚  â”‚
â”‚  â”‚  - Online/Off   â”‚  â”‚  - Daily summary â”‚  â”‚  - Device config        â”‚  â”‚
â”‚  â”‚  - Pending cnt  â”‚  â”‚  - CSV export    â”‚  â”‚  - User preferences     â”‚  â”‚
â”‚  â”‚  - Conflicts    â”‚  â”‚  - Metrics       â”‚  â”‚  - About                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ HTTPS + JWT
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVICE WORKER LAYER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     CACHE STRATEGY                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Static Assetsâ”‚  â”‚  API Calls   â”‚  â”‚  Background Sync         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Cache-First  â”‚  â”‚ Network-Firstâ”‚  â”‚  - sync-redemptions      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ (HTML/CSS/JS)â”‚  â”‚ (with cache) â”‚  â”‚  - sync-conflicts        â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     INDEXEDDB STORAGE                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚pending_redemptionsâ”‚  â”‚vouchers_cacheâ”‚  â”‚  sync_conflicts   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - local_id      â”‚  â”‚  - code       â”‚  â”‚  - conflict_id    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - voucher_code  â”‚  â”‚  - guest_name â”‚  â”‚  - local_data     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - timestamp     â”‚  â”‚  - validation â”‚  â”‚  - server_data    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - attempts      â”‚  â”‚  - cached_at  â”‚  â”‚  - resolution     â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ REST API
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API LAYER (Express.js)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MIDDLEWARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚  â”‚  â”‚ Correlation  â”‚â†’ â”‚     Auth     â”‚â†’ â”‚ Rate Limiter â”‚              â”‚  â”‚
â”‚  â”‚  â”‚     ID       â”‚  â”‚ JWT + RBAC   â”‚  â”‚  Per Device  â”‚              â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚  â”‚                           â”‚                                          â”‚  â”‚
â”‚  â”‚                           â–¼                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚                    ROUTES                                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /api/auth/*      /api/vouchers/*    /api/sync/*             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  /api/reports/*   /api/health                                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                           â”‚                                          â”‚  â”‚
â”‚  â”‚                           â–¼                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚                  SERVICES LAYER                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ VoucherService  â”‚  â”‚  SyncService    â”‚  â”‚ CryptoServiceâ”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ - emit()        â”‚  â”‚ - sync()        â”‚  â”‚ - HMAC       â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ - validate()    â”‚  â”‚ - conflicts()   â”‚  â”‚ - verify()   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ - redeem()      â”‚  â”‚ - resolve()     â”‚  â”‚ - generate() â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   QRService     â”‚  â”‚  ReportService  â”‚  â”‚ AuthService  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ - generate()    â”‚  â”‚ - csv()         â”‚  â”‚ - login()    â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ - parse()       â”‚  â”‚ - metrics()     â”‚  â”‚ - refresh()  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ - validate()    â”‚  â”‚ - reconcile()   â”‚  â”‚ - logout()   â”‚  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                           â”‚                                          â”‚  â”‚
â”‚  â”‚                           â–¼                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚                  ERROR HANDLER                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - AppError / ValidationError / ConflictError                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Structured logging (Winston)                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  - Correlation ID tracking                                    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ SQL Transactions
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATA LAYER (SQLite)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DATABASE SCHEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚    users     â”‚     â”‚  cafeterias  â”‚     â”‚       stays          â”‚  â”‚â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚â”‚
â”‚  â”‚  â”‚ id (PK)      â”‚     â”‚ id (PK)      â”‚     â”‚ id (PK)              â”‚  â”‚â”‚
â”‚  â”‚  â”‚ username     â”‚     â”‚ name         â”‚     â”‚ guest_name           â”‚  â”‚â”‚
â”‚  â”‚  â”‚ password_hashâ”‚     â”‚ location     â”‚     â”‚ room_number          â”‚  â”‚â”‚
â”‚  â”‚  â”‚ role         â”‚     â”‚ is_active    â”‚     â”‚ checkin_date         â”‚  â”‚â”‚
â”‚  â”‚  â”‚ cafeteria_id â”‚     â”‚ created_at   â”‚     â”‚ checkout_date        â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ created_at           â”‚  â”‚â”‚
â”‚  â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                              â”‚                        â”‚               â”‚â”‚
â”‚  â”‚                              â–¼                        â–¼               â”‚â”‚
â”‚  â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚â”‚
â”‚  â”‚                       â”‚           vouchers               â”‚       â”‚â”‚
â”‚  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚â”‚
â”‚  â”‚                       â”‚ id (PK)                              â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ code (UNIQUE)  â—„â”€â”€â”€ HPN-YYYY-####   â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ stay_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ valid_from (DATE)                    â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ valid_until (DATE)                   â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ hmac_signature (SHA256)              â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ status (active/redeemed/expired)     â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ created_at                           â”‚       â”‚â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚
â”‚  â”‚                                      â”‚                               â”‚â”‚
â”‚  â”‚                                      â–¼                               â”‚â”‚
â”‚  â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚â”‚
â”‚  â”‚                       â”‚         redemptions              â”‚       â”‚â”‚
â”‚  â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚â”‚
â”‚  â”‚                       â”‚ id (PK)                              â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ voucher_id (FK, UNIQUE) â—„â”€â”€ ATOMIC   â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ cafeteria_id (FK)                    â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ device_id                            â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ redeemed_at (TIMESTAMP)              â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ redeemed_by (FK)                     â”‚       â”‚â”‚
â”‚  â”‚                       â”‚ correlation_id                       â”‚       â”‚â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚                      sync_log                                  â”‚  â”‚â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚â”‚
â”‚  â”‚  â”‚ id (PK)                                                        â”‚  â”‚â”‚
â”‚  â”‚  â”‚ device_id                                                      â”‚  â”‚â”‚
â”‚  â”‚  â”‚ operation (redemption/conflict)                               â”‚  â”‚â”‚
â”‚  â”‚  â”‚ payload (JSON)                                                â”‚  â”‚â”‚
â”‚  â”‚  â”‚ result (success/error)                                        â”‚  â”‚â”‚
â”‚  â”‚  â”‚ synced_at (TIMESTAMP)                                         â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                                                                       â”‚â”‚
â”‚  â”‚  KEY FEATURES:                                                        â”‚â”‚
â”‚  â”‚  âœ“ UNIQUE(voucher_id) en redemptions â†’ Previene doble canje         â”‚â”‚
â”‚  â”‚  âœ“ Foreign Keys con CASCADE â†’ Integridad referencial                â”‚â”‚
â”‚  â”‚  âœ“ Indexes en code, device_id â†’ Performance                         â”‚â”‚
â”‚  â”‚  âœ“ WAL mode â†’ Concurrencia mejorada                                 â”‚â”‚
â”‚  â”‚  âœ“ Transacciones ACID â†’ Consistencia garantizada                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Persistent Volume
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INFRAESTRUCTURA (Fly.io)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DEPLOYMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚  â”‚  â”‚   Load Balancer  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   App Instance   â”‚                 â”‚   â”‚
â”‚  â”‚  â”‚   (Fly Proxy)    â”‚         â”‚   (Node.js)      â”‚                 â”‚   â”‚
â”‚  â”‚  â”‚   - SSL/TLS      â”‚         â”‚   - Port 8080    â”‚                 â”‚   â”‚
â”‚  â”‚  â”‚   - Health check â”‚         â”‚   - 256MB RAM    â”‚                 â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â”‚                                        â”‚                            â”‚   â”‚
â”‚  â”‚                                        â–¼                            â”‚   â”‚
â”‚  â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚  â”‚                               â”‚  Volume (1GB)    â”‚                  â”‚   â”‚
â”‚  â”‚                               â”‚  /data/          â”‚                  â”‚   â”‚
â”‚  â”‚                               â”‚  - vouchers.db   â”‚                  â”‚   â”‚
â”‚  â”‚                               â”‚  - logs/         â”‚                  â”‚   â”‚
â”‚  â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                    SECRETS MANAGER                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - VOUCHER_SECRET (32-byte hex)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - JWT_SECRET (32-byte hex)                                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - ALLOWED_ORIGINS (domains)                                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                    MONITORING                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Health checks (every 30s)                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Logs aggregation                                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Metrics export                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - Auto-restart on failure                                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO DE DATOS CRÃTICOS

### 1. EMISIÃ“N DE VOUCHERS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin/   â”‚  POST   â”‚   API    â”‚ Generateâ”‚   DB     â”‚  Return â”‚  Admin   â”‚
â”‚Reception â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚/vouchers â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ INSERT   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ + QR PDF â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚ 1. stay_id         â”‚ 2. Validate        â”‚ 3. Generate code    â”‚
     â”‚    valid_from      â”‚    - Stay exists   â”‚    HPN-2025-0001    â”‚
     â”‚    valid_until     â”‚    - Dates valid   â”‚                     â”‚
     â”‚    breakfast_count â”‚    - In range      â”‚ 4. Create HMAC      â”‚
     â”‚                    â”‚                     â”‚    SHA256 signature â”‚
     â”‚                    â”‚ 5. Transaction()   â”‚                     â”‚
     â”‚                    â”‚    BEGIN           â”‚ 6. INSERT vouchers  â”‚
     â”‚                    â”‚    FOR EACH        â”‚    (atomic)         â”‚
     â”‚                    â”‚    COMMIT          â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 7. Generate QR     â”‚                     â”‚
     â”‚                    â”‚    code|hmac|date  â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 8. Return: { vouchers: [...], qr_images: [...] }
```

### 2. VALIDACIÃ“N DE VOUCHER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Cafeteria â”‚  POST   â”‚   API    â”‚  Query  â”‚   DB     â”‚  Return â”‚Cafeteria â”‚
â”‚   PWA    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚/validate â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  SELECT  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Result  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚ 1. code, hmac      â”‚ 2. Get voucher     â”‚ 3. Return data      â”‚
     â”‚                    â”‚                     â”‚    + stay info      â”‚
     â”‚                    â”‚ 4. Verify HMAC     â”‚                     â”‚
     â”‚                    â”‚    timing-safe     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 5. Check status    â”‚                     â”‚
     â”‚                    â”‚    âœ“ active?       â”‚                     â”‚
     â”‚                    â”‚    âœ“ not expired?  â”‚                     â”‚
     â”‚                    â”‚    âœ“ not redeemed? â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. { valid: true/false, reason, voucher_data }
```

### 3. CANJE ONLINE (ATÃ“MICO)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Cafeteria â”‚  POST   â”‚   API    â”‚TRANSACT.â”‚   DB     â”‚  Return â”‚Cafeteria â”‚
â”‚   PWA    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ /redeem  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ATOMIC   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Success â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚ code, cafeteria,   â”‚                     â”‚                     â”‚
     â”‚ device_id          â”‚ 1. BEGIN TRANS.    â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 2. SELECT voucher  â”‚                     â”‚
     â”‚                    â”‚    FOR UPDATE      â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 3. Validate        â”‚                     â”‚
     â”‚                    â”‚    âœ“ exists        â”‚                     â”‚
     â”‚                    â”‚    âœ“ active        â”‚                     â”‚
     â”‚                    â”‚    âœ“ in date range â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 4. INSERT          â”‚ 5. UNIQUE constraintâ”‚
     â”‚                    â”‚    redemptions     â”‚    PREVENTS DUPLICATEâ”‚
     â”‚                    â”‚    (voucher_id)    â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 6. UPDATE voucher  â”‚                     â”‚
     â”‚                    â”‚    status=redeemed â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ 7. COMMIT          â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 8. { success: true, redemption: {...} }
     â”‚
     â”‚ ERROR HANDLING:
     â”‚ - CONSTRAINT UNIQUE â†’ { error: 'ALREADY_REDEEMED', details }
     â”‚ - Expired â†’ { error: 'EXPIRED' }
     â”‚ - Invalid â†’ { error: 'INVALID_VOUCHER' }
```

### 4. CANJE OFFLINE + SINCRONIZACIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Cafeteria â”‚                    â”‚IndexedDB â”‚                    â”‚   API    â”‚
â”‚   PWA    â”‚                    â”‚  Local   â”‚                    â”‚  Server  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                               â”‚                               â”‚
     â”‚ 1. Scan QR                    â”‚                               â”‚
     â”‚    (OFFLINE)                  â”‚                               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                               â”‚
     â”‚ 2. Validate HMAC locally      â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚ 3. INSERT pending_redemptions â”‚                               â”‚
     â”‚    {                          â”‚                               â”‚
     â”‚      local_id: uuid(),        â”‚                               â”‚
     â”‚      voucher_code,            â”‚                               â”‚
     â”‚      cafeteria_id,            â”‚                               â”‚
     â”‚      device_id,               â”‚                               â”‚
     â”‚      timestamp,               â”‚                               â”‚
     â”‚      attempts: 0              â”‚                               â”‚
     â”‚    }                          â”‚                               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚ 4. Show "Queued for sync"    â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚ ... TIME PASSES ...           â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚ 5. ONLINE detected            â”‚                               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                               â”‚
     â”‚ 6. Service Worker triggers    â”‚                               â”‚
     â”‚    'sync-redemptions'         â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚                               â”‚ 7. POST /api/sync/redemptions â”‚
     â”‚                               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                               â”‚   { device_id,                â”‚
     â”‚                               â”‚     redemptions: [...] }      â”‚
     â”‚                               â”‚                               â”‚
     â”‚                               â”‚ 8. For each redemption:       â”‚
     â”‚                               â”‚    - Try redeem()             â”‚
     â”‚                               â”‚    - Handle conflicts         â”‚
     â”‚                               â”‚    - Log to sync_log          â”‚
     â”‚                               â”‚                               â”‚
     â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                               â”‚ 9. Return results:            â”‚
     â”‚                               â”‚    { synced: [...],           â”‚
     â”‚                               â”‚      conflicts: [...],        â”‚
     â”‚                               â”‚      errors: [...] }          â”‚
     â”‚                               â”‚                               â”‚
     â”‚ 10. DELETE synced from        â”‚                               â”‚
     â”‚     IndexedDB                 â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚ 11. KEEP conflicts for        â”‚                               â”‚
     â”‚     user resolution           â”‚                               â”‚
     â”‚                               â”‚                               â”‚
     â”‚ 12. Show notification         â”‚                               â”‚
     â”‚     "X canjes sincronizados"  â”‚                               â”‚
     â”‚                               â”‚                               â”‚
```

### 5. REPORTE CSV (Test Case #10)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Admin/    â”‚   GET   â”‚   API    â”‚  Query  â”‚   DB     â”‚  Return â”‚  Admin   â”‚
â”‚Reception â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚/reports/ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  JOIN    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   CSV    â”‚
â”‚          â”‚         â”‚redemptionsâ”‚         â”‚ COMPLEX  â”‚         â”‚ Download â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚ ?from=2025-01-01   â”‚                     â”‚                     â”‚
     â”‚ &to=2025-01-31     â”‚                     â”‚                     â”‚
     â”‚ &format=csv        â”‚                     â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ SELECT              â”‚                     â”‚
     â”‚                    â”‚   v.code,           â”‚                     â”‚
     â”‚                    â”‚   s.guest_name,     â”‚                     â”‚
     â”‚                    â”‚   s.room_number,    â”‚                     â”‚
     â”‚                    â”‚   r.redeemed_at,    â”‚                     â”‚
     â”‚                    â”‚   c.name AS cafe,   â”‚                     â”‚
     â”‚                    â”‚   r.device_id       â”‚                     â”‚
     â”‚                    â”‚ FROM redemptions r  â”‚                     â”‚
     â”‚                    â”‚ JOIN vouchers v     â”‚                     â”‚
     â”‚                    â”‚ JOIN stays s        â”‚                     â”‚
     â”‚                    â”‚ JOIN cafeterias c   â”‚                     â”‚
     â”‚                    â”‚ WHERE redeemed_at   â”‚                     â”‚
     â”‚                    â”‚   BETWEEN ? AND ?   â”‚                     â”‚
     â”‚                    â”‚ ORDER BY            â”‚                     â”‚
     â”‚                    â”‚   redeemed_at       â”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚                    â”‚ Generate CSV:       â”‚                     â”‚
     â”‚                    â”‚ - Header row        â”‚                     â”‚
     â”‚                    â”‚ - Data rows         â”‚                     â”‚
     â”‚                    â”‚ - Include online+offâ”‚                     â”‚
     â”‚                    â”‚                     â”‚                     â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ CSV File:
     â”‚ code,guest_name,room,redeemed_at,cafeteria,device_id
     â”‚ HPN-2025-0001,Juan PÃ©rez,101,2025-01-15 08:30,CafeterÃ­a,device-001
     â”‚ HPN-2025-0002,Ana GarcÃ­a,102,2025-01-15 08:45,CafeterÃ­a,device-001
     â”‚ ...
```

---

## ğŸ” SEGURIDAD Y AUTENTICACIÃ“N

### JWT Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚  POST   â”‚   API    â”‚  Query  â”‚   DB     â”‚
â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  /login  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  users   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚
     â”‚ username, password â”‚                     â”‚
     â”‚                    â”‚ 1. SELECT user      â”‚
     â”‚                    â”‚    WHERE username   â”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚ 2. bcrypt.compare() â”‚
     â”‚                    â”‚    password vs hash â”‚
     â”‚                    â”‚                     â”‚
     â”‚                    â”‚ 3. jwt.sign({       â”‚
     â”‚                    â”‚      user_id,       â”‚
     â”‚                    â”‚      username,      â”‚
     â”‚                    â”‚      role,          â”‚
     â”‚                    â”‚      cafeteria_id   â”‚
     â”‚                    â”‚    }, JWT_SECRET,   â”‚
     â”‚                    â”‚    { expiresIn })   â”‚
     â”‚                    â”‚                     â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ { token, user: {...} }
     â”‚
     â”‚ Store in:
     â”‚ - localStorage (token)
     â”‚ - IndexedDB (backup)
     â”‚
     â”‚ Use in requests:
     â”‚ Authorization: Bearer <token>
```

### RBAC (Role-Based Access Control)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ROLES                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    admin     â”‚   â”‚  reception   â”‚   â”‚  cafeteria   â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ âœ“ All access â”‚   â”‚ âœ“ View all   â”‚   â”‚ âœ“ Scan QR    â”‚   â”‚
â”‚  â”‚ âœ“ Manage     â”‚   â”‚ âœ“ Emit       â”‚   â”‚ âœ“ Validate   â”‚   â”‚
â”‚  â”‚   users      â”‚   â”‚   vouchers   â”‚   â”‚ âœ“ Redeem     â”‚   â”‚
â”‚  â”‚ âœ“ Reports    â”‚   â”‚ âœ“ Reports    â”‚   â”‚ âœ“ Sync       â”‚   â”‚
â”‚  â”‚ âœ“ Settings   â”‚   â”‚ âœ“ View stays â”‚   â”‚ âœ“ View own   â”‚   â”‚
â”‚  â”‚              â”‚   â”‚              â”‚   â”‚   reports    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IMPLEMENTACIÃ“N:
- JWT payload: { user_id, username, role, cafeteria_id }
- Middleware: requireRole(['admin', 'reception'])
- Route protection: authMiddleware + requireRole
- Frontend: conditional rendering based on role
```

### HMAC Signing (Anti-Tampering)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              VOUCHER INTEGRITY PROTECTION                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Data: code|valid_from|valid_until|stay_id                 â”‚
â”‚  Example: "HPN-2025-0001|2025-01-15|2025-01-17|123"        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  HMAC-SHA256(data, VOUCHER_SECRET)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â”‚                                    â”‚
â”‚                        â–¼                                    â”‚
â”‚  Signature: a1b2c3d4e5f6...  (64 hex chars)               â”‚
â”‚                                                             â”‚
â”‚  QR Code Content: code|signature|valid_until               â”‚
â”‚                                                             â”‚
â”‚  VERIFICATION (timing-safe):                               â”‚
â”‚  1. Parse QR data                                          â”‚
â”‚  2. Fetch voucher from DB (get stay_id, dates)             â”‚
â”‚  3. Regenerate HMAC with same data                         â”‚
â”‚  4. crypto.timingSafeEqual(expected, received)             â”‚
â”‚  5. If match â†’ Valid, If not â†’ Tampered                    â”‚
â”‚                                                             â”‚
â”‚  SECURITY:                                                  â”‚
â”‚  âœ“ 32-byte random secret (env var)                         â”‚
â”‚  âœ“ SHA-256 algorithm                                       â”‚
â”‚  âœ“ Timing-safe comparison                                  â”‚
â”‚  âœ“ No exposure in logs                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š MODELO DE DATOS DETALLADO

### Tabla: users
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,  -- bcrypt
  full_name TEXT NOT NULL,
  role TEXT NOT NULL CHECK(role IN ('admin', 'reception', 'cafeteria')),
  cafeteria_id INTEGER,  -- NULL para admin/reception
  is_active BOOLEAN NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  
  FOREIGN KEY (cafeteria_id) REFERENCES cafeterias(id) ON DELETE SET NULL,
  
  INDEX idx_users_username ON users(username),
  INDEX idx_users_role ON users(role)
);
```

### Tabla: cafeterias
```sql
CREATE TABLE cafeterias (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL UNIQUE,
  location TEXT,
  is_active BOOLEAN NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  
  INDEX idx_cafeterias_active ON cafeterias(is_active)
);
```

### Tabla: stays
```sql
CREATE TABLE stays (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  guest_name TEXT NOT NULL,
  guest_email TEXT,
  guest_phone TEXT,
  room_number TEXT NOT NULL,
  checkin_date TEXT NOT NULL,   -- YYYY-MM-DD
  checkout_date TEXT NOT NULL,  -- YYYY-MM-DD
  number_of_guests INTEGER NOT NULL DEFAULT 1,
  breakfast_included BOOLEAN NOT NULL DEFAULT 1,
  created_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  
  CHECK(checkin_date <= checkout_date),
  
  INDEX idx_stays_dates ON stays(checkin_date, checkout_date),
  INDEX idx_stays_room ON stays(room_number)
);
```

### Tabla: vouchers (CORE)
```sql
CREATE TABLE vouchers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT NOT NULL UNIQUE,  -- HPN-YYYY-####
  stay_id INTEGER NOT NULL,
  valid_from TEXT NOT NULL,   -- YYYY-MM-DD
  valid_until TEXT NOT NULL,  -- YYYY-MM-DD
  hmac_signature TEXT NOT NULL,  -- SHA-256 hex (64 chars)
  status TEXT NOT NULL DEFAULT 'active' 
    CHECK(status IN ('active', 'redeemed', 'expired', 'cancelled')),
  created_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  
  FOREIGN KEY (stay_id) REFERENCES stays(id) ON DELETE CASCADE,
  
  CHECK(valid_from <= valid_until),
  
  INDEX idx_vouchers_code ON vouchers(code),
  INDEX idx_vouchers_stay ON vouchers(stay_id),
  INDEX idx_vouchers_status ON vouchers(status),
  INDEX idx_vouchers_dates ON vouchers(valid_from, valid_until)
);
```

### Tabla: redemptions (CRITICAL - ATOMIC)
```sql
CREATE TABLE redemptions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  voucher_id INTEGER NOT NULL UNIQUE,  -- â—„â”€â”€ PREVIENE DUPLICADOS
  cafeteria_id INTEGER NOT NULL,
  device_id TEXT NOT NULL,  -- Para tracking offline
  redeemed_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  redeemed_by INTEGER NOT NULL,  -- user_id
  correlation_id TEXT,  -- Para tracking distribuido
  notes TEXT,
  
  FOREIGN KEY (voucher_id) REFERENCES vouchers(id) ON DELETE CASCADE,
  FOREIGN KEY (cafeteria_id) REFERENCES cafeterias(id) ON DELETE RESTRICT,
  FOREIGN KEY (redeemed_by) REFERENCES users(id) ON DELETE RESTRICT,
  
  INDEX idx_redemptions_voucher ON redemptions(voucher_id),
  INDEX idx_redemptions_cafeteria ON redemptions(cafeteria_id),
  INDEX idx_redemptions_device ON redemptions(device_id),
  INDEX idx_redemptions_date ON redemptions(redeemed_at),
  INDEX idx_redemptions_correlation ON redemptions(correlation_id)
);

-- CRITICAL: UNIQUE constraint es la clave para atomicidad
-- Si dos requests intentan canjear el mismo voucher:
-- 1. Primer INSERT â†’ Success
-- 2. Segundo INSERT â†’ SQLITE_CONSTRAINT_UNIQUE error
-- 3. Catch error â†’ Return "ALREADY_REDEEMED"
```

### Tabla: sync_log (AUDITORÃA)
```sql
CREATE TABLE sync_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  device_id TEXT NOT NULL,
  operation TEXT NOT NULL CHECK(operation IN ('redemption', 'conflict', 'metrics')),
  payload TEXT,  -- JSON con detalles
  result TEXT NOT NULL CHECK(result IN ('success', 'error', 'conflict')),
  error_message TEXT,
  synced_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
  
  INDEX idx_sync_log_device ON sync_log(device_id),
  INDEX idx_sync_log_date ON sync_log(synced_at),
  INDEX idx_sync_log_result ON sync_log(result)
);
```

---

## ğŸ§ª CASOS DE PRUEBA CRÃTICOS

### Test Case #1: EmisiÃ³n de Vouchers
```javascript
âœ“ Emitir N vouchers para una estadÃ­a
âœ“ CÃ³digos Ãºnicos y secuenciales
âœ“ HMAC correcto para cada voucher
âœ“ QR genera correctamente
âœ“ Fechas vÃ¡lidas (dentro de estadÃ­a)
âœ“ TransacciÃ³n atÃ³mica (all or nothing)
```

### Test Case #5: Canje AtÃ³mico
```javascript
âœ“ Canje exitoso actualiza voucher y crea redemption
âœ“ UNIQUE constraint previene doble canje
âœ“ Transaction rollback en error
âœ“ Logs de auditorÃ­a completos
```

### Test Case #7: SincronizaciÃ³n Offline
```javascript
âœ“ Canjes se guardan en IndexedDB
âœ“ Background sync dispara automÃ¡ticamente
âœ“ Canjes se envÃ­an en batch
âœ“ Responses procesan correctamente
âœ“ Synced items se eliminan de IndexedDB
âœ“ Conflictos se preservan para resoluciÃ³n
```

### Test Case #10: ReconciliaciÃ³n CSV (CRÃTICO)
```javascript
describe('CSV Report - Online + Offline Redemptions', () => {
  it('should include 7 rows: 3 online + 4 offline', async () => {
    // Setup
    await emitVouchers(10);  // Emitir 10 vouchers
    
    // 3 canjes online
    await redeem('HPN-2025-0001', { device: 'online-1', cafe: 1 });
    await redeem('HPN-2025-0002', { device: 'online-1', cafe: 1 });
    await redeem('HPN-2025-0003', { device: 'online-2', cafe: 1 });
    
    // 4 canjes offline (sync despuÃ©s)
    await redeemOffline('HPN-2025-0004', { device: 'offline-1' });
    await redeemOffline('HPN-2025-0005', { device: 'offline-1' });
    await redeemOffline('HPN-2025-0006', { device: 'offline-2' });
    await redeemOffline('HPN-2025-0007', { device: 'offline-2' });
    await syncRedemptions();
    
    // Generate report
    const csv = await GET('/api/reports/redemptions?format=csv');
    
    // Assertions
    expect(csv.split('\n')).toHaveLength(8);  // header + 7 data
    expect(csv).toContain('device_id');
    expect(csv).toContain('cafeteria');
    expect(csv).toContain('HPN-2025-0001');
    expect(csv).toContain('HPN-2025-0007');
    expect(csv).toContain('offline-1');
    expect(csv).toContain('offline-2');
    expect(csv).not.toContain('HPN-2025-0008');  // No canjeado
  });
});
```

---

## ğŸ”§ TECNOLOGÃAS Y VERSIONES

```yaml
Backend:
  runtime: Node.js 18+
  framework: Express.js 4.18+
  database: SQLite (better-sqlite3 9.2+)
  auth: jsonwebtoken 9.0+
  crypto: bcryptjs 2.4+
  validation: zod 3.22+
  logging: winston 3.11+
  qr: qrcode 1.5+
  security:
    - helmet 7.1+
    - cors 2.8+
    - express-rate-limit 7.1+

Frontend (PWA):
  framework: React 18+
  router: React Router 6+
  storage: idb 7+
  qr-scanner: html5-qrcode 2.3+
  http: axios 1.6+
  offline: workbox 7+
  
Testing:
  unit: Jest 29+
  integration: Supertest 6+
  e2e: Playwright 1.40+
  coverage: Istanbul (via Jest)

DevOps:
  ci-cd: GitHub Actions
  hosting: Fly.io
  containerization: Docker (multi-stage)
  monitoring: Fly.io metrics + custom logs

Tools:
  linting: ESLint 8+
  formatting: Prettier 3+
  git-hooks: Husky 8+ (opcional)
```

---

## ğŸ“ˆ MÃ‰TRICAS Y KPIs

### SLIs (Service Level Indicators)
```
Availability:
  - Uptime: >99.9% (8.76h downtime/year mÃ¡x)
  - Health check success rate: >99.5%

Performance:
  - API response time p50: <200ms
  - API response time p95: <500ms
  - API response time p99: <1000ms
  - PWA First Contentful Paint: <2s
  - PWA Time to Interactive: <3s

Reliability:
  - Error rate: <1% of total requests
  - Redemption success rate: >95%
  - Sync success rate: >98%
  - Database transaction success: >99.9%

Scalability:
  - Concurrent users: >50
  - Requests per second: >20
  - Database size: <1GB for 100k vouchers
```

### Business Metrics
```
Operational:
  - Vouchers emitted per day
  - Redemption rate (redeemed/emitted)
  - Average redemption time (minutes after checkin)
  - Peak redemption hours
  - Top performing cafeterias
  
Efficiency:
  - Time to reconcile reports: <5 minutes
  - Offline sync latency: <10 seconds
  - Conflict resolution time: <1 minute per conflict
  
Quality:
  - Duplicate redemption attempts: <0.1%
  - Expired voucher usage attempts: tracked
  - Invalid QR scans: tracked
  - User satisfaction: >4.5/5
```

---

## ğŸ¨ UI/UX WIREFRAMES

### Login Screen (PWA)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¨  Hostal Playa Norte             â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ‘¤ Usuario                    â”‚ â”‚
â”‚  â”‚ [_________________________]   â”‚ â”‚
â”‚  â”‚                               â”‚ â”‚
â”‚  â”‚ ğŸ”’ ContraseÃ±a                 â”‚ â”‚
â”‚  â”‚ [_________________________]   â”‚ â”‚
â”‚  â”‚                               â”‚ â”‚
â”‚  â”‚  [ ğŸ” Iniciar SesiÃ³n ]        â”‚ â”‚
â”‚  â”‚                               â”‚ â”‚
â”‚  â”‚  RecuÃ©rdame  â˜‘ï¸                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  ğŸ“¶ Estado: Online âœ“                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scanner Screen (Cafeteria Role)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Escanear Voucher         ğŸ‘¤ Juan â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚    ğŸ“·                        â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚    [QR Scanner Area]        â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚    Apunte al cÃ³digo QR      â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                     â”‚
â”‚  ğŸ’³ Ingresar cÃ³digo manualmente     â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CÃ³digo: [_______________]   â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ [ Validar ]                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  ğŸ“Š Hoy: 12 canjes                  â”‚
â”‚  â±ï¸  Ãšltima sincronizaciÃ³n: 10:30   â”‚
â”‚  ğŸ“¶ Online âœ“ | 0 pendientes         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Voucher Detail (Pre-Redeem)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Confirmar Canje                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  âœ… Voucher VÃ¡lido                  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ« HPN-2025-0042            â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ ğŸ‘¤ HuÃ©sped                  â”‚   â”‚
â”‚  â”‚    Juan PÃ©rez GarcÃ­a        â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ ğŸ›ï¸  HabitaciÃ³n: 101          â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ ğŸ“… VÃ¡lido                    â”‚   â”‚
â”‚  â”‚    15/01/2025 - 17/01/2025  â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚ ğŸ³ Desayuno incluido         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  [ âœ“ Confirmar Canje ]              â”‚
â”‚  [ âœ• Cancelar ]                     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Success Screen
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     â”‚
â”‚         âœ…                           â”‚
â”‚                                     â”‚
â”‚    Â¡Canje Exitoso!                  â”‚
â”‚                                     â”‚
â”‚  ğŸ« HPN-2025-0042                   â”‚
â”‚  ğŸ‘¤ Juan PÃ©rez GarcÃ­a                â”‚
â”‚  â° 15/01/2025 08:45                 â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [ Escanear Siguiente ]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  [ Ver Detalles ]                   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sync Status (Offline Mode)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Estado de SincronizaciÃ³n         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ğŸ“¶ Modo: Offline                   â”‚
â”‚                                     â”‚
â”‚  â³ Canjes Pendientes: 4            â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ• HPN-2025-0050 - 08:30    â”‚   â”‚
â”‚  â”‚ ğŸ• HPN-2025-0051 - 08:32    â”‚   â”‚
â”‚  â”‚ ğŸ• HPN-2025-0052 - 08:35    â”‚   â”‚
â”‚  â”‚ ğŸ• HPN-2025-0053 - 08:40    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚
â”‚  â„¹ï¸ Se sincronizarÃ¡n automÃ¡ticamenteâ”‚
â”‚     cuando haya conexiÃ³n            â”‚
â”‚                                     â”‚
â”‚  [ ğŸ”„ Reintentar Ahora ]            â”‚
â”‚                                     â”‚
â”‚  âš ï¸  Conflictos: 1                  â”‚
â”‚  [ Ver Conflictos ]                 â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**FIN DEL BLUEPRINT ARQUITECTÃ“NICO**

Este documento complementa la PLANIFICACIÃ“N_MAESTRA_DESARROLLO.md
